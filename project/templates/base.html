<!doctype html>
<html lang="en" {% if current_user.is_authenticated %} {% if current_user.accent_color=='blue' %}
  style="--primary-color: #3b82f6; --secondary-color: #06b6d4; --accent-color: #a855f7; --bg-gradient-end: #0f172a;" {%
  elif current_user.accent_color=='pink' %}
  style="--primary-color: #ec4899; --secondary-color: #f43f5e; --accent-color: #f59e0b; --bg-gradient-end: #4c1d95;" {%
  elif current_user.accent_color=='green' %}
  style="--primary-color: #10b981; --secondary-color: #059669; --accent-color: #3b82f6; --bg-gradient-end: #064e3b;" {%
  elif current_user.accent_color=='yellow' %}
  style="--primary-color: #eab308; --secondary-color: #f59e0b; --accent-color: #ec4899; --bg-gradient-end: #422006;" {%
  endif %} {% endif %}>

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
  <link href="{{ url_for('static', filename='css/style.css') }}" rel="stylesheet">
  <link rel="icon" type="image/png" href="{{ url_for('static', filename='images/logo.png') }}">
  <title>Writer's Hub</title>

  <style>
    /* Prevent content from hiding behind the mobile footer */
    @media (max-width: 991.98px) {
      body {
        padding-bottom: 90px !important;
      }
    }
  </style>
</head>

<body class="loading-active {% block body_class %}{% endblock %}">
  <!-- Global Page Loading Overlay -->
  <div id="page-loader" class="page-loader-wrapper">
    <div class="spinner-border loader-spinner" role="status">
      <span class="visually-hidden">Loading...</span>
    </div>
  </div>

  {% if request.endpoint != 'main.login_page' and request.endpoint != 'main.register_page' %}
  <nav class="navbar navbar-expand-lg navbar-glass navbar-dark mb-4 sticky-top">
    <div class="container">

      <!-- Brand -->
      <a class="navbar-brand me-1 me-lg-3 d-flex flex-column justify-content-center"
        href="{{ url_for('main.main_page') }}" style="line-height: 1;">
        <img src="{{ url_for('static', filename='images/weblogo.png') }}" alt="Writer's Hub"
          style="max-height: 90px; width: auto;">
        {% if current_user.is_authenticated %}
        <span class="d-none d-sm-block text-muted" style="font-size: 0.75rem; font-weight: normal; margin-top: 4px;">@{{
          current_user.username }}</span>
        {% endif %}
      </a>

      <!-- Desktop Links (Hidden on mobile) -->
      <div class="d-none d-lg-flex flex-grow-1 align-items-center ms-4 order-1">
        <ul class="navbar-nav me-auto">
          <li class="nav-item"><a class="nav-link" href="{{ url_for('main.main_page') }}">Home Feed</a></li>
          <li class="nav-item"><a class="nav-link" href="{{ url_for('main.explore_page') }}">Explore</a></li>
          {% if current_user.is_authenticated %}
          <li class="nav-item">
            <a class="nav-link d-flex align-items-center" href="{{ url_for('main.messages') }}">
              Messages
              {% set unread_msgs = current_user.new_messages() %}
              {% if unread_msgs > 0 %}
              <span class="badge rounded-pill bg-danger ms-2" style="font-size: 0.65rem;">{{ unread_msgs }}</span>
              {% endif %}
            </a>
          </li>
          {% endif %}
          <li class="nav-item"><a class="nav-link" href="{{ url_for('main.create_post') }}">New Post</a></li>
        </ul>
      </div>

      <!-- Always Visible Container (Search, Notif, Profile) -->
      <div class="d-flex align-items-center gap-1 gap-sm-2 order-1 order-lg-2 ms-auto">
        <!-- Search Form -->
        <form class="d-flex m-0" action="{{ url_for('main.search') }}" method="GET" style="max-width: 140px;">
          <input class="form-control border-0 px-2 py-1 shadow-none" type="search" name="q" placeholder="Search..."
            aria-label="Search"
            style="min-width: 60px; width: 100%; background: rgba(255,255,255,0.8); font-size: 0.85rem; height: 32px; border-radius: 0.5rem 0 0 0.5rem !important;">
          <button class="btn btn-primary px-2 py-1 shadow-none bg-gradient" type="submit"
            style="height: 32px; border-radius: 0 0.5rem 0.5rem 0 !important; border: none;"><i class="bi bi-search"
              style="font-size: 0.85rem;"></i></button>
        </form>

        {% if current_user.is_authenticated %}
        <!-- Notifications -->
        <ul class="navbar-nav flex-row align-items-center m-0 p-0">
          <li class="nav-item dropdown me-1">
            <a class="nav-link position-relative d-flex align-items-center p-1 px-2 text-white" href="#"
              id="navbarNotificationDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false"
              onclick="markNotificationsRead()">
              <i class="bi bi-bell fs-5"></i>
              {% set unread_count = current_user.notifications.filter_by(is_read=False).count() %}
              {% if unread_count > 0 %}
              <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger"
                style="font-size: 0.55rem; margin-top: 8px; margin-left: -5px;" id="notif-badge">
                {{ unread_count }}
              </span>
              {% endif %}
            </a>
            <ul class="dropdown-menu dropdown-menu-end shadow-lg position-absolute mt-2"
              aria-labelledby="navbarNotificationDropdown"
              style="width: 280px; max-height: 400px; overflow-y: auto; right: -40px;">
              <li>
                <h6 class="dropdown-header text-muted text-center mb-1">Recent Notifications</h6>
              </li>
              <li>
                <hr class="dropdown-divider">
              </li>
              {% set notifs = current_user.get_recent_notifications(10) %}
              {% if notifs %}
              {% for notif in notifs %}
              <li>
                <a class="dropdown-item py-2 {% if not notif.is_read %}bg-light{% endif %}"
                  href="{{ notif.link or '#' }}" style="white-space: normal; line-height: 1.3;">
                  <small class="d-block mb-1 text-wrap">{{ notif.message }}</small>
                  <small class="text-muted d-block" style="font-size: 0.70rem;">{{ notif.timestamp.strftime('%b %d,
                    %H:%M') }}</small>
                </a>
              </li>
              {% endfor %}
              {% else %}
              <li><span class="dropdown-item-text text-muted text-center py-3"><small>No new
                    notifications</small></span></li>
              {% endif %}
            </ul>
          </li>

          <!-- Profile -->
          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle d-flex align-items-center p-0 text-white" href="#"
              id="navbarProfileDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
              <img src="{{ get_image_url(current_user.image_file, 'profile_pics') }}" alt="Profile"
                class="rounded-circle shadow-sm"
                style="width: 32px; height: 32px; object-fit: cover; border: 2px solid var(--glass-border);">
            </a>
            <ul class="dropdown-menu dropdown-menu-end shadow-lg position-absolute mt-2"
              aria-labelledby="navbarProfileDropdown" style="right: 0;">
              <li>
                <h6 class="dropdown-header text-muted text-center mb-1">@{{ current_user.username }}</h6>
              </li>
              <li><a class="dropdown-item d-flex align-items-center" href="{{ url_for('main.profile_page') }}"><i
                    class="bi bi-person me-2"></i> Profile</a></li>
              <li><a class="dropdown-item d-flex align-items-center" href="{{ url_for('main.settings_page') }}"><i
                    class="bi bi-gear me-2"></i> Settings</a></li>
              <li><a class="dropdown-item d-flex align-items-center" href="#" data-bs-toggle="modal"
                  data-bs-target="#aboutDevModal"><i class="bi bi-info-circle me-2"></i> About Dev</a></li>
              <li>
                <hr class="dropdown-divider">
              </li>
              <li><a class="dropdown-item d-flex align-items-center text-danger"
                  href="{{ url_for('main.logout_page') }}"><i class="bi bi-box-arrow-right me-2"></i> Logout</a></li>
            </ul>
          </li>
        </ul>
        {% else %}
        <div class="d-none d-lg-flex gap-2 ms-2">
          <a class="btn btn-sm btn-outline-light" href="{{ url_for('main.login_page') }}">Login</a>
          <a class="btn btn-sm btn-auth" href="{{ url_for('main.register_page') }}">Register</a>
        </div>
        {% endif %}
      </div>



    </div>
  </nav>

  <!-- Mobile Bottom Navigation Bar -->
  <div class="d-lg-none fixed-bottom navbar-glass px-2 pt-2 pb-1"
    style="border-top: 1px solid var(--glass-border); border-bottom: none; z-index: 1030;">
    <div class="container d-flex justify-content-around align-items-end mb-2">
      <a href="{{ url_for('main.main_page') }}"
        class="text-center text-decoration-none text-white opacity-75 {% if request.endpoint == 'main.main_page' %}opacity-100{% endif %}">
        <i
          class="bi bi-house-door fs-4 d-block {% if request.endpoint == 'main.main_page' %}text-primary{% endif %} mb-1"></i>
        <span style="font-size: 0.65rem;"
          class="{% if request.endpoint == 'main.main_page' %}text-primary fw-bold{% endif %}">Home</span>
      </a>
      <a href="{{ url_for('main.explore_page') }}"
        class="text-center text-decoration-none text-white opacity-75 {% if request.endpoint == 'main.explore_page' %}opacity-100{% endif %}">
        <i
          class="bi bi-compass fs-4 d-block {% if request.endpoint == 'main.explore_page' %}text-primary{% endif %} mb-1"></i>
        <span style="font-size: 0.65rem;"
          class="{% if request.endpoint == 'main.explore_page' %}text-primary fw-bold{% endif %}">Explore</span>
      </a>

      {% if current_user.is_authenticated %}
      <a href="{{ url_for('main.messages') }}"
        class="text-center text-decoration-none text-white opacity-75 position-relative {% if request.endpoint == 'main.messages' or (request.endpoint is not none and 'chat' in request.endpoint) %}opacity-100{% endif %}">
        <i
          class="bi bi-chat fs-4 d-block {% if request.endpoint == 'main.messages' or (request.endpoint is not none and 'chat' in request.endpoint) %}text-primary{% endif %} mb-1"></i>
        <span style="font-size: 0.65rem;"
          class="{% if request.endpoint == 'main.messages' or (request.endpoint is not none and 'chat' in request.endpoint) %}text-primary fw-bold{% endif %}">Chats</span>
        {% set unread_msgs = current_user.new_messages() %}
        {% if unread_msgs > 0 %}
        <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger"
          style="font-size: 0.55rem; transform: translate(-30%, 10%) !important;">{{ unread_msgs }}</span>
        {% endif %}
      </a>
      {% else %}
      <a href="{{ url_for('main.login_page') }}" class="text-center text-decoration-none text-white opacity-75">
        <i class="bi bi-box-arrow-in-right fs-4 d-block mb-1"></i>
        <span style="font-size: 0.65rem;">Login</span>
      </a>
      {% endif %}
    </div>
  </div>
  {% endif %}

  <main class="container mb-5">
    {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
    {% for category, message in messages %}
    <div class="alert alert-{{ category }} glass-card py-2 mb-4 text-center">{{ message }}</div>
    {% endfor %}
    {% endif %}
    {% endwith %}
    {% block content %}{% endblock %}
  </main>

  <!-- About Developer Modal -->
  <div class="modal fade" id="aboutDevModal" tabindex="-1" aria-labelledby="aboutDevModalLabel" aria-hidden="true"
    style="z-index: 9999;">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content text-center py-4 px-3"
        style="background: rgba(15, 23, 42, 0.9); backdrop-filter: blur(20px); border: 1px solid var(--glass-border); border-radius: 1.5rem; color: var(--text-color); box-shadow: 0 15px 35px rgba(0,0,0,0.6), 0 0 20px rgba(168, 85, 247, 0.2);">
        <div class="modal-body position-relative">
          <button type="button" class="btn-close position-absolute top-0 end-0 m-2" data-bs-dismiss="modal"
            aria-label="Close" style="filter: invert(1) grayscale(100%) brightness(200%);"></button>

          <div class="position-relative d-inline-block mb-3">
            <img src="https://github.com/vipulyadav-2004.png" alt="Vipul Yadav" class="rounded-circle shadow-lg"
              style="width: 120px; height: 120px; object-fit: cover; border: 3px solid var(--primary-color);">
            <span class="position-absolute bottom-0 end-0 bg-success border border-dark rounded-circle"
              style="width: 24px; height: 24px; margin-bottom: 5px; margin-right: 5px; box-shadow: 0 0 10px rgba(16, 185, 129, 0.6); display: flex; align-items: center; justify-content: center;">
              <i class="bi bi-check-circle-fill text-white" style="font-size: 14px;"></i>
            </span>
          </div>

          <h3 class="fw-bolder gradient-text mb-1 d-inline-block">Vipul Yadav</h3>
          <div class="mb-3">
            <span class="badge rounded-pill px-3 py-1 mt-1"
              style="background: linear-gradient(135deg, #FFD700, #F7931A); color: #000; box-shadow: 0 4px 10px rgba(255, 215, 0, 0.4); border: 1px solid rgba(255,255,255,0.4);">
              <i class="bi bi-patch-check-fill me-1"></i> Owner & Developer
            </span>
          </div>

          <p class="text-muted small mb-4 px-2" style="font-size: 0.95rem; line-height: 1.5;">
            Passionate full-stack developer dedicated to building beautiful, premium web applications. Welcome to my web
            space! Let's connect and build something awesome.
          </p>

          <div class="d-flex justify-content-center gap-4 mb-4">
            <a href="https://github.com/vipulyadav-2004" target="_blank"
              class="text-decoration-none d-flex flex-column align-items-center group" style="color: inherit;">
              <div
                class="btn btn-outline-secondary rounded-circle d-flex align-items-center justify-content-center shadow-sm mb-1 social-hover-btn"
                style="width: 55px; height: 55px;">
                <i class="bi bi-github fs-4 text-white"></i>
              </div>
              <small class="text-muted" style="font-size: 0.75rem;">GitHub</small>
            </a>
            <a href="https://www.linkedin.com/in/vipul-yadav-1362a7310" target="_blank"
              class="text-decoration-none d-flex flex-column align-items-center group" style="color: inherit;">
              <div
                class="btn btn-outline-secondary rounded-circle d-flex align-items-center justify-content-center shadow-sm mb-1 social-hover-btn"
                style="width: 55px; height: 55px;">
                <i class="bi bi-linkedin fs-4" style="color: #60a5fa;"></i>
              </div>
              <small class="text-muted" style="font-size: 0.75rem;">LinkedIn</small>
            </a>
            <a href="https://www.instagram.com/sketchesbyvips?igsh=dnhhYTlsZTdmMmZu" target="_blank"
              class="text-decoration-none d-flex flex-column align-items-center group" style="color: inherit;">
              <div
                class="btn btn-outline-secondary rounded-circle d-flex align-items-center justify-content-center shadow-sm mb-1 social-hover-btn"
                style="width: 55px; height: 55px;">
                <i class="bi bi-instagram fs-4" style="color: #ec4899;"></i>
              </div>
              <small class="text-muted" style="font-size: 0.75rem;">Instagram</small>
            </a>
          </div>

          <a href="mailto:vipulyadav0709@gmail.com"
            class="btn btn-auth w-100 rounded-pill py-3 text-decoration-none shadow-lg d-flex justify-content-center align-items-center"
            style="font-size: 1.05rem;">
            <i class="bi bi-envelope-fill me-2 fs-5"></i> vipulyadav0709@gmail.com
          </a>
        </div>
      </div>
    </div>
  </div>

  <style>
    .social-hover-btn {
      transition: transform 0.2s ease, box-shadow 0.2s ease !important;
      border-color: rgba(255, 255, 255, 0.2) !important;
      background: rgba(255, 255, 255, 0.05) !important;
    }

    .group:hover .social-hover-btn {
      transform: translateY(-5px);
      box-shadow: 0 8px 15px rgba(255, 255, 255, 0.1) !important;
      background: rgba(255, 255, 255, 0.1) !important;
    }
  </style>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <!-- Global Client-Side Image Compression Script for Vercel Payload Restrictions -->
  <script>
    document.addEventListener("DOMContentLoaded", function () {
      const fileInputs = document.querySelectorAll('input[type="file"]');

      fileInputs.forEach(input => {
        // Find if this input auto-submits by checking its inline onchange attribute
        const onchangeAttr = input.getAttribute('onchange');
        const hasAutoSubmit = onchangeAttr && onchangeAttr.includes('submit()');

        if (hasAutoSubmit) {
          // Remove the inline onchange so it doesn't trigger prematurely before compression
          input.removeAttribute('onchange');
        }

        const form = input.closest('form');
        let submitBtn = null;
        if (form) {
          // Find primary submit button
          submitBtn = form.querySelector('[type="submit"]') || form.querySelector('button:not([type="button"])');
        }

        input.addEventListener('change', async function (e) {
          const file = e.target.files[0];
          if (!file || !file.type.startsWith('image/')) {
            if (hasAutoSubmit && file) { form.submit(); }
            return;
          }

          // Only compress if file is over ~1MB (1,048,576 bytes) to bypass Vercel 4.5MB limits safely
          if (file.size > 1024 * 1024) {
            try {
              // Lock submit button to prevent sending massive file halfway through compression
              let originalBtnText = '';
              if (submitBtn) {
                originalBtnText = submitBtn.innerHTML;
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Compressing...';
              }

              // Try locking visual picture labels if it exists for auto-submits (like Profile Page PFP input)
              const label = document.querySelector(`label[for="${input.id}"]`);
              let originalLabelHTML = '';
              if (label && hasAutoSubmit) {
                originalLabelHTML = label.innerHTML;
                label.innerHTML = '<div class="spinner-border spinner-border-sm text-primary" role="status"></div>';
              }

              const compressedFile = await compressImage(file);
              const dataTransfer = new DataTransfer();
              dataTransfer.items.add(compressedFile);
              input.files = dataTransfer.files; // Overwrite memory

              // Restore UI Elements
              if (submitBtn) {
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalBtnText;
              }
              if (label && hasAutoSubmit) label.innerHTML = originalLabelHTML;

            } catch (err) {
              console.error("Image Compression failed", err);
              if (submitBtn) submitBtn.disabled = false;
            }
          }

          // If the form relied on auto-submit, manually trigger it now!
          if (hasAutoSubmit) {
            if (form) form.submit();
          }
        });
      });

      // Async Compression Promise Driver
      function compressImage(file) {
        return new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.readAsDataURL(file);
          reader.onload = event => {
            const img = new Image();
            img.src = event.target.result;
            img.onload = () => {
              const canvas = document.createElement('canvas');
              let width = img.width;
              let height = img.height;
              const MAX_DIMENSION = 1400; // Cap large dimensions

              if (width > height && width > MAX_DIMENSION) {
                height *= MAX_DIMENSION / width;
                width = MAX_DIMENSION;
              } else if (height > MAX_DIMENSION) {
                width *= MAX_DIMENSION / height;
                height = MAX_DIMENSION;
              }

              canvas.width = width;
              canvas.height = height;
              const ctx = canvas.getContext('2d');
              ctx.drawImage(img, 0, 0, width, height);

              // Output logic as high-quality JPEG
              canvas.toBlob(blob => {
                resolve(new File([blob], file.name.replace(/\.[^/.]+$/, "") + ".jpg", {
                  type: 'image/jpeg',
                  lastModified: Date.now()
                }));
              }, 'image/jpeg', 0.85); // 85% visual compression
            };
            img.onerror = reject;
          };
          reader.onerror = reject;
        });
      }
    });

    // --- Loading UI Animations ---

    // 1. Hide full screen loader gracefully when the page completely paints
    window.addEventListener('load', function () {
      const loader = document.getElementById('page-loader');
      if (loader) {
        loader.classList.add('fade-out');
        document.body.classList.remove('loading-active');
        setTimeout(() => {
          loader.style.display = 'none';
        }, 300); // Wait for CSS transition to complete
      }
    });

    // 2. Intercept All Standard Forms to instantly show spinners on submit
    document.addEventListener("DOMContentLoaded", function () {
      const forms = document.querySelectorAll("form");
      forms.forEach(form => {
        form.addEventListener("submit", function (e) {
          if (form.getAttribute('data-prevent-loader') === 'true') return;

          const submitBtn = form.querySelector('[type="submit"]') || form.querySelector('button:not([type="button"])');
          if (submitBtn && !submitBtn.disabled) {
            // Don't override if the Image Compression script is already loading the button
            if (!submitBtn.innerHTML.includes('spinner-border')) {
              if (submitBtn.innerHTML.includes('bi-search')) {
                // Search Button
                submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>';
              } else {
                // Standard Button String
                submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>Loading...';
              }
              submitBtn.classList.add('opacity-75', 'pe-none'); // Lock interaction
            }
          }
        });
      });
    });
  </script>

  <!-- Post Body Read More Toggle -->
  <script>
    document.addEventListener("DOMContentLoaded", function () {
      const postBodies = document.querySelectorAll('.post-body-content');
      postBodies.forEach(body => {
        if (body.scrollHeight > body.clientHeight) {
          const btn = document.createElement('button');
          btn.className = 'btn btn-link p-0 text-decoration-none mt-1 fw-bold';
          btn.style.color = 'var(--accent-color, #a855f7)';
          btn.style.fontSize = '0.9rem';
          btn.textContent = 'Read more...';
          btn.onclick = function () {
            if (btn.textContent === 'Read more...') {
              body.style.webkitLineClamp = 'unset';
              body.style.lineClamp = 'unset';
              btn.textContent = 'Read less';
            } else {
              body.style.webkitLineClamp = '10';
              body.style.lineClamp = '10';
              btn.textContent = 'Read more...';
            }
          };
          body.parentNode.appendChild(btn);
        }
      });
    });
  </script>

  {% if current_user.is_authenticated %}
  <script>
    function markNotificationsRead() {
      const badge = document.getElementById('notif-badge');
      if (badge) {
        badge.style.display = 'none';

        // Let the dropdown open smoothly while we tell the server it's read
        fetch("{{ url_for('main.read_notifications') }}", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": "{{ csrf_token() }}"
          }
        }).catch(err => console.error("Error marking read:", err));
      }
    }
  </script>
  {% endif %}
</body>

</html>