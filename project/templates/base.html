<!doctype html>
<html lang="en" {% if current_user.is_authenticated %} {% if current_user.accent_color=='blue' %}
  style="--primary-color: #3b82f6; --secondary-color: #06b6d4; --accent-color: #a855f7; --bg-gradient-end: #0f172a;" {%
  elif current_user.accent_color=='pink' %}
  style="--primary-color: #ec4899; --secondary-color: #f43f5e; --accent-color: #f59e0b; --bg-gradient-end: #4c1d95;" {%
  elif current_user.accent_color=='green' %}
  style="--primary-color: #10b981; --secondary-color: #059669; --accent-color: #3b82f6; --bg-gradient-end: #064e3b;" {%
  elif current_user.accent_color=='yellow' %}
  style="--primary-color: #eab308; --secondary-color: #f59e0b; --accent-color: #ec4899; --bg-gradient-end: #422006;" {%
  endif %} {% endif %}>

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
  <link href="{{ url_for('static', filename='css/style.css') }}" rel="stylesheet">
  <title>Writer's Hub</title>

</head>

<body class="{% block body_class %}{% endblock %}">
  {% if request.endpoint != 'main.login_page' and request.endpoint != 'main.register_page' %}
  <nav class="navbar navbar-expand-lg navbar-glass navbar-dark mb-4 sticky-top">
    <div class="container">
      <a class="navbar-brand" href="{{ url_for('main.main_page') }}">
        Writer's Hub
        {% if current_user.is_authenticated %}
        <span class="d-block text-muted" style="font-size: 0.75rem; font-weight: normal;">@{{ current_user.username
          }}</span>
        {% endif %}
      </a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav"
        aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav me-auto">
          <li class="nav-item"><a class="nav-link" href="{{ url_for('main.main_page') }}">Home Feed</a></li>
          <li class="nav-item"><a class="nav-link" href="{{ url_for('main.explore_page') }}">Explore</a></li>
          {% if current_user.is_authenticated %}
          <li class="nav-item">
            <a class="nav-link d-flex align-items-center" href="{{ url_for('main.messages') }}">
              Messages
              {% set unread_msgs = current_user.new_messages() %}
              {% if unread_msgs > 0 %}
              <span class="badge rounded-pill bg-danger ms-2" style="font-size: 0.65rem;">{{ unread_msgs }}</span>
              {% endif %}
            </a>
          </li>
          <li class="nav-item"><a class="nav-link" href="{{ url_for('main.create_post') }}">New Post</a></li>
          {% endif %}
        </ul>

        <form class="d-flex mx-auto" action="{{ url_for('main.search') }}" method="GET">
          <input class="form-control me-2" type="search" name="q" placeholder="Search users..." aria-label="Search"
            style="width: 250px; background: rgba(255,255,255,0.7);">
          <button class="btn btn-outline-primary" type="submit">Search</button>
        </form>

        <ul class="navbar-nav ms-auto align-items-center">
          {% if current_user.is_authenticated %}

          <li class="nav-item dropdown me-3">
            <a class="nav-link position-relative d-flex align-items-center py-0" href="#"
              id="navbarNotificationDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false"
              onclick="markNotificationsRead()">
              <i class="bi bi-bell fs-5"></i>
              {% set unread_count = current_user.notifications.filter_by(is_read=False).count() %}
              {% if unread_count > 0 %}
              <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger"
                style="font-size: 0.6rem; margin-top: 8px; margin-left: -5px;" id="notif-badge">
                {{ unread_count }}
              </span>
              {% endif %}
            </a>
            <ul class="dropdown-menu dropdown-menu-end shadow-lg" aria-labelledby="navbarNotificationDropdown"
              style="width: 320px; max-height: 400px; overflow-y: auto;">
              <li>
                <h6 class="dropdown-header text-muted text-center mb-1">Recent Notifications</h6>
              </li>
              <li>
                <hr class="dropdown-divider">
              </li>
              {% set notifs = current_user.get_recent_notifications(10) %}
              {% if notifs %}
              {% for notif in notifs %}
              <li>
                <a class="dropdown-item py-2 {% if not notif.is_read %}bg-light{% endif %}"
                  href="{{ notif.link or '#' }}" style="white-space: normal; line-height: 1.3;">
                  <small class="d-block mb-1 text-wrap">{{ notif.message }}</small>
                  <small class="text-muted d-block" style="font-size: 0.70rem;">{{ notif.timestamp.strftime('%b %d,
                    %H:%M') }}</small>
                </a>
              </li>
              {% endfor %}
              {% else %}
              <li><span class="dropdown-item-text text-muted text-center py-3"><small>No new
                    notifications</small></span></li>
              {% endif %}
            </ul>
          </li>

          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle d-flex align-items-center py-0" href="#" id="navbarProfileDropdown"
              role="button" data-bs-toggle="dropdown" aria-expanded="false">
              <img src="{{ url_for('static', filename='profile_pics/' + current_user.image_file) }}" alt="Profile"
                class="rounded-circle"
                style="width: 36px; height: 36px; object-fit: cover; border: 2px solid var(--glass-border);">
            </a>
            <ul class="dropdown-menu dropdown-menu-end shadow-lg" aria-labelledby="navbarProfileDropdown">
              <li>
                <h6 class="dropdown-header text-muted text-center mb-1">@{{ current_user.username }}</h6>
              </li>
              <li><a class="dropdown-item d-flex align-items-center" href="{{ url_for('main.profile_page') }}"><i
                    class="bi bi-person me-2"></i> Profile</a></li>
              <li><a class="dropdown-item d-flex align-items-center" href="{{ url_for('main.settings_page') }}"><i
                    class="bi bi-gear me-2"></i>
                  Settings</a></li>
              <li>
                <hr class="dropdown-divider">
              </li>
              <li><a class="dropdown-item d-flex align-items-center text-danger"
                  href="{{ url_for('main.logout_page') }}"><i class="bi bi-box-arrow-right me-2"></i> Logout</a></li>
            </ul>
          </li>
          {% else %}
          <li class="nav-item"><a class="nav-link" href="{{ url_for('main.login_page') }}">Login</a></li>
          <li class="nav-item"><a class="nav-link" href="{{ url_for('main.register_page') }}">Register</a></li>
          {% endif %}
        </ul>
      </div>
    </div>
  </nav>
  {% endif %}
  <main class="container">
    {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
    {% for category, message in messages %}
    <div class="alert alert-{{ category }} glass-card py-2 mb-4 text-center">{{ message }}</div>
    {% endfor %}
    {% endif %}
    {% endwith %}
    {% block content %}{% endblock %}
  </main>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  {% if current_user.is_authenticated %}
  <script>
    function markNotificationsRead() {
      const badge = document.getElementById('notif-badge');
      if (badge) {
        badge.style.display = 'none';

        // Let the dropdown open smoothly while we tell the server it's read
        fetch("{{ url_for('main.read_notifications') }}", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": "{{ csrf_token() }}"
          }
        }).catch(err => console.error("Error marking read:", err));
      }
    }
  </script>
  {% endif %}
</body>

</html>