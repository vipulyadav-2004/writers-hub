{% extends 'base.html' %}
{% block title %}
<title>Profile - Writer's Hub</title>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-10 col-lg-8 mx-auto">
        <!-- User Header Card -->
        <div class="glass-card text-center py-5 mb-5">
            <h2 class="auth-title mb-4">User Profile</h2>
            <form method="POST" action="" enctype="multipart/form-data" id="profile-form">
                {{ form.hidden_tag() }}

                <div class="mb-4">
                    <div class="position-relative d-inline-block mb-3" style="width: 150px; height: 150px;">
                        <img class="rounded-circle account-img" src="{{ image_file }}" alt="User Profile Picture"
                            style="width: 150px; height: 150px; object-fit: cover;">

                        {{ form.picture(class="d-none", id="picture-input",
                        onchange="document.getElementById('profile-form').submit();") }}
                        <label for="picture-input"
                            class="position-absolute bg-white text-primary rounded-circle d-flex align-items-center justify-content-center shadow mb-0"
                            style="bottom: 0px; left: 0px; width: 36px; height: 36px; cursor: pointer; border: 1px solid #ddd; z-index: 10;">
                            <i class="bi bi-pencil-fill" style="font-size: 1rem;"></i>
                        </label>
                    </div>

                    <div class="d-flex justify-content-center align-items-center mb-2">
                        <h3 class="gradient-text mb-0 me-2 {% if form.username.errors %}d-none{% endif %}"
                            id="username-display">{{ username }}</h3>
                        <a href="javascript:void(0);"
                            onclick="document.getElementById('username-display').classList.add('d-none'); document.getElementById('username-edit-container').classList.remove('d-none'); this.classList.add('d-none');"
                            class="text-secondary {% if form.username.errors %}d-none{% endif %}"
                            id="username-edit-icon" title="Edit Username">
                            <i class="bi bi-pencil-fill"></i>
                        </a>
                    </div>

                    <div id="username-edit-container"
                        class="mb-3 d-flex justify-content-center align-items-center mx-auto {% if not form.username.errors %}d-none{% endif %}"
                        style="max-width: 300px;">
                        {{ form.username(class="form-control form-control-sm me-2" + (" is-invalid" if
                        form.username.errors else "")) }}
                        <button type="submit" class="btn btn-sm btn-success">Save</button>
                        <button type="button" class="btn btn-sm btn-secondary ms-1"
                            onclick="document.getElementById('username-edit-container').classList.add('d-none'); document.getElementById('username-display').classList.remove('d-none'); document.getElementById('username-edit-icon').classList.remove('d-none');">Cancel</button>
                    </div>

                    {% if current_user.email == 'vipulyadav0709@gmail.com' %}
                    <div class="mb-2 mt-1">
                        <span class="badge rounded-pill px-3 py-2"
                            style="background: linear-gradient(135deg, #FFD700, #F7931A); box-shadow: 0 4px 15px rgba(255, 215, 0, 0.4); border: 1px solid rgba(255,255,255,0.4); color: #000; display: inline-flex; align-items: center;">
                            <i class="bi bi-patch-check-fill me-2" style="font-size: 1.1rem;"></i>
                            <span class="fw-bold fs-6">Owner & Developer</span>
                        </span>
                    </div>
                    {% endif %}

                    {% if form.username.errors %}
                    <div class="text-danger small mb-3">
                        {% for error in form.username.errors %}
                        {{ error }}
                        {% endfor %}
                    </div>
                    {% endif %}
                    {% if form.picture.errors %}
                    <div class="text-danger small mb-3">
                        {% for error in form.picture.errors %}
                        {{ error }}
                        {% endfor %}
                    </div>
                    {% endif %}

                    <!-- Removed email row entirely as it's not looking necessary or could be placed better -->
                    <!-- In fact I will put it back but add counts underneath it -->
                    <p class="text-muted">{{ current_user.email }}</p>

                    <div class="d-flex justify-content-center gap-4 mt-3">
                        <div class="text-center">
                            <strong class="d-block text-black">{{ current_user.posts|length }}</strong>
                            <span class="text-muted small">Posts</span>
                        </div>
                        <a href="{{ url_for('main.followers', username=current_user.username) }}"
                            class="text-decoration-none" style="color: inherit;">
                            <div class="text-center">
                                <strong class="d-block text-black">{{ current_user.followers.count() }}</strong>
                                <span class="text-muted small">Followers</span>
                            </div>
                        </a>
                        <a href="{{ url_for('main.following', username=current_user.username) }}"
                            class="text-decoration-none" style="color: inherit;">
                            <div class="text-center">
                                <strong class="d-block text-black">{{ current_user.followed.count() }}</strong>
                                <span class="text-muted small">Following</span>
                            </div>
                        </a>
                    </div>
                </div>
            </form>

            <div class="d-grid gap-2 d-sm-flex justify-content-sm-center">
                <a href="{{ url_for('main.create_post') }}" class="btn btn-auth px-4">New Post</a>
                <a href="{{ url_for('main.logout_page') }}" class="btn btn-outline-secondary px-4">Logout</a>
            </div>
        </div>

        <!-- User's Specific Posts -->
        
        <!-- Tabs for Posts -->
        <ul class="nav nav-pills mb-4 justify-content-center" id="profileTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active rounded-pill px-4" id="published-tab" data-bs-toggle="tab" data-bs-target="#published" type="button" role="tab" aria-controls="published" aria-selected="true">My Stories</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link rounded-pill px-4" id="saved-tab" data-bs-toggle="tab" data-bs-target="#saved" type="button" role="tab" aria-controls="saved" aria-selected="false">Saved</button>
            </li>
        </ul>

        <div class="tab-content" id="profileTabsContent">
            <!-- Published Posts Tab -->
            <div class="tab-pane fade show active" id="published" role="tabpanel" aria-labelledby="published-tab">
                {% if posts %}
                {% for post in posts %}
                {% include 'post_card_profile.html' %}
                {% endfor %}
                {% else %}
                <div class="glass-card text-center p-4">
                    <p class="text-muted">You haven't written anything yet.</p>
                    <a href="{{ url_for('main.create_post') }}" class="btn btn-sm btn-primary">Write your first story</a>
                </div>
                {% endif %}
            </div>

            <!-- Saved Posts Tab -->
            <div class="tab-pane fade" id="saved" role="tabpanel" aria-labelledby="saved-tab">
                {% if saved_posts %}
                {% for post in saved_posts %}
                {% include 'post_card_profile.html' %}
                {% endfor %}
                {% else %}
                <div class="glass-card text-center p-4">
                    <p class="text-muted">No saved posts yet.</p>
                    <a href="{{ url_for('main.main_page') }}" class="btn btn-sm btn-primary">Explore stories</a>
                </div>
                {% endif %}
            </div>
        </div>
</div>
</div>
{% endblock %}